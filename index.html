<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>张老三无限马里奥 | 横屏冒险</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        marioRed: '#E53E3E',
                        marioBlue: '#3182CE',
                        marioYellow: '#ED8936',
                        marioGreen: '#48BB78',
                    },
                    fontFamily: {
                        pixel: ['"Press Start 2P"', 'cursive'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .game-shadow {
                box-shadow: 0 0 20px rgba(0, 0, 0, 0.3), 0 0 0 4px #333;
            }
            .pixel-border {
                @apply border-4 border-gray-800 rounded-sm;
                box-shadow: inset 0 0 0 2px #fff;
            }
            .btn-pixel {
                @apply bg-marioBlue text-white font-bold py-3 px-6 pixel-border transition-all duration-200 transform hover:scale-105 active:scale-95;
            }
            .touch-btn {
                @apply w-16 h-16 rounded-full bg-black/50 backdrop-blur-sm flex items-center justify-center text-white text-3xl pixel-border;
            }
        }
    </style>
    <!-- 引入像素字体 -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center justify-center p-4 overflow-hidden font-pixel">
    <div class="max-w-5xl w-full aspect-[16/9] relative game-shadow bg-sky-300 rounded-lg overflow-hidden">
        <!-- 游戏画布 -->
        <canvas id="gameCanvas" class="w-full h-full"></canvas>
        
        <!-- 开始界面 -->
        <div id="startScreen" class="absolute inset-0 flex flex-col items-center justify-center bg-black/70 backdrop-blur-sm z-20">
            <h1 class="text-4xl md:text-5xl text-marioRed mb-6 text-center">无限马里奥</h1>
            <button id="startBtn" class="btn-pixel mb-4">
                <i class="fa fa-play mr-2"></i>开始游戏
            </button>
            <div class="text-sm text-gray-300 text-center">
                <p><i class="fa fa-keyboard-o mr-1"></i> 方向键: 移动 | 空格键: 跳跃</p>
                <p class="mt-2"><i class="fa fa-mobile text-lg mr-1"></i> 触摸屏幕: 左右移动 | 跳跃按钮</p>
            </div>
        </div>
        
        <!-- 游戏结束界面 -->
        <div id="gameOverScreen" class="absolute inset-0 flex flex-col items-center justify-center bg-black/80 backdrop-blur-sm z-20 hidden">
            <h2 class="text-4xl text-marioRed mb-4">游戏结束!</h2>
            <p class="text-2xl mb-6">得分: <span id="finalScore" class="text-marioYellow">0</span></p>
            <button id="restartBtn" class="btn-pixel">
                <i class="fa fa-refresh mr-2"></i>重新开始
            </button>
        </div>
        
        <!-- 游戏UI -->
        <div id="gameUI" class="absolute top-4 left-4 right-4 flex justify-between items-center z-10 hidden">
            <div class="bg-black/60 backdrop-blur-sm px-3 py-1 pixel-border text-lg">
                <i class="fa fa-star text-marioYellow mr-2"></i>得分: <span id="score">0</span>
            </div>
            <div class="bg-black/60 backdrop-blur-sm px-3 py-1 pixel-border text-lg">
                <i class="fa fa-level-up text-marioGreen mr-2"></i>关卡: <span id="level">1</span>
            </div>
        </div>
        
        <!-- 移动设备控制按钮 -->
        <div id="touchControls" class="absolute bottom-4 left-4 right-4 flex justify-between items-center z-10 hidden md:hidden">
            <div class="flex gap-4">
                <button id="leftBtn" class="touch-btn">
                    <i class="fa fa-arrow-left"></i>
                </button>
                <button id="rightBtn" class="touch-btn">
                    <i class="fa fa-arrow-right"></i>
                </button>
            </div>
            <button id="jumpBtn" class="touch-btn">
                <i class="fa fa-arrow-up"></i>
            </button>
        </div>
    </div>

    <script>
        // 游戏主类
        class MarioGame {
            constructor() {
                // 获取画布和上下文
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                
                // 设置画布尺寸
                this.resizeCanvas();
                window.addEventListener('resize', () => this.resizeCanvas());
                
                // 游戏元素
                this.player = null;
                this.platforms = [];
                this.coins = [];
                this.enemies = [];
                
                // 游戏状态
                this.gameRunning = false;
                this.gameOver = false;
                this.score = 0;
                this.level = 1;
                this.speed = 3;
                this.spawnRate = 1500; // 平台生成速率(ms)
                this.lastSpawnTime = 0;
                
                // 控制状态
                this.keys = {
                    left: false,
                    right: false,
                    jump: false
                };
                
                // 触摸控制状态
                this.touchControls = {
                    left: false,
                    right: false,
                    jump: false
                };
                
                // 绑定事件
                this.bindEvents();
                
                // 初始化游戏
                this.initGame();
                
                // 开始游戏循环
                requestAnimationFrame(this.gameLoop.bind(this));
            }
            
            // 调整画布尺寸
            resizeCanvas() {
                const container = this.canvas.parentElement;
                this.canvas.width = container.clientWidth;
                this.canvas.height = container.clientHeight;
            }
            
            // 绑定事件监听
            bindEvents() {
                // 键盘控制
                window.addEventListener('keydown', (e) => {
                    switch(e.key) {
                        case 'ArrowLeft':
                            this.keys.left = true;
                            break;
                        case 'ArrowRight':
                            this.keys.right = true;
                            break;
                        case ' ':
                            this.keys.jump = true;
                            break;
                    }
                });
                
                window.addEventListener('keyup', (e) => {
                    switch(e.key) {
                        case 'ArrowLeft':
                            this.keys.left = false;
                            break;
                        case 'ArrowRight':
                            this.keys.right = false;
                            break;
                        case ' ':
                            this.keys.jump = false;
                            break;
                    }
                });
                
                // 触摸控制
                document.getElementById('leftBtn').addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.touchControls.left = true;
                });
                document.getElementById('leftBtn').addEventListener('touchend', (e) => {
                    e.preventDefault();
                    this.touchControls.left = false;
                });
                
                document.getElementById('rightBtn').addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.touchControls.right = true;
                });
                document.getElementById('rightBtn').addEventListener('touchend', (e) => {
                    e.preventDefault();
                    this.touchControls.right = false;
                });
                
                document.getElementById('jumpBtn').addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.touchControls.jump = true;
                });
                document.getElementById('jumpBtn').addEventListener('touchend', (e) => {
                    e.preventDefault();
                    this.touchControls.jump = false;
                });
                
                // 鼠标控制（移动设备备用）
                document.getElementById('leftBtn').addEventListener('mousedown', () => {
                    this.touchControls.left = true;
                });
                document.getElementById('leftBtn').addEventListener('mouseup', () => {
                    this.touchControls.left = false;
                });
                document.getElementById('leftBtn').addEventListener('mouseleave', () => {
                    this.touchControls.left = false;
                });
                
                document.getElementById('rightBtn').addEventListener('mousedown', () => {
                    this.touchControls.right = true;
                });
                document.getElementById('rightBtn').addEventListener('mouseup', () => {
                    this.touchControls.right = false;
                });
                document.getElementById('rightBtn').addEventListener('mouseleave', () => {
                    this.touchControls.right = false;
                });
                
                document.getElementById('jumpBtn').addEventListener('mousedown', () => {
                    this.touchControls.jump = true;
                });
                document.getElementById('jumpBtn').addEventListener('mouseup', () => {
                    this.touchControls.jump = false;
                });
                document.getElementById('jumpBtn').addEventListener('mouseleave', () => {
                    this.touchControls.jump = false;
                });
                
                // 游戏控制按钮
                document.getElementById('startBtn').addEventListener('click', () => this.startGame());
                document.getElementById('restartBtn').addEventListener('click', () => this.restartGame());
            }
            
            // 初始化游戏
            initGame() {
                // 创建玩家
                this.player = {
                    x: this.canvas.width / 4,
                    y: this.canvas.height / 2,
                    width: 40,
                    height: 60,
                    velocityX: 0,
                    velocityY: 0,
                    speed: 8,
                    jumpForce: -18,
                    gravity: 0.8,
                    onGround: false,
                    color: '#E53E3E' // 马里奥红色
                };
                
                // 创建初始平台
                this.platforms = [];
                this.createPlatform(this.canvas.width / 2, this.canvas.height - 40, this.canvas.width / 2, 20);
                this.createPlatform(this.canvas.width / 4, this.canvas.height - 150, 120, 20);
                this.createPlatform(3 * this.canvas.width / 4, this.canvas.height - 250, 120, 20);
                
                // 重置游戏状态
                this.coins = [];
                this.enemies = [];
                this.score = 0;
                this.level = 1;
                this.speed = 3;
                this.spawnRate = 1500;
                this.gameRunning = false;
                this.gameOver = false;
                
                // 更新UI
                this.updateUI();
            }
            
            // 开始游戏
            startGame() {
                document.getElementById('startScreen').classList.add('hidden');
                document.getElementById('gameUI').classList.remove('hidden');
                document.getElementById('touchControls').classList.remove('hidden');
                this.gameRunning = true;
                this.lastSpawnTime = Date.now();
            }
            
            // 重新开始游戏
            restartGame() {
                document.getElementById('gameOverScreen').classList.add('hidden');
                this.initGame();
                this.startGame();
            }
            
            // 创建平台
            createPlatform(x, y, width, height) {
                this.platforms.push({
                    x,
                    y,
                    width,
                    height,
                    color: '#48BB78' // 绿色平台
                });
            }
            
            // 创建金币
            createCoin(x, y) {
                this.coins.push({
                    x,
                    y,
                    size: 20,
                    value: 10,
                    color: '#ED8936', // 金币黄色
                    collected: false
                });
            }
            
            // 创建敌人
            createEnemy(x, y) {
                this.enemies.push({
                    x,
                    y,
                    width: 30,
                    height: 30,
                    speed: Math.random() * 2 + 1,
                    direction: Math.random() > 0.5 ? 1 : -1,
                    color: '#2D3748' // 敌人黑色
                });
            }
            
            // 检测碰撞
            checkCollision(a, b) {
                return a.x < b.x + b.width &&
                       a.x + a.width > b.x &&
                       a.y < b.y + b.height &&
                       a.y + a.height > b.y;
            }
            
            // 更新玩家
            updatePlayer() {
                const player = this.player;
                
                // 应用重力
                player.velocityY += player.gravity;
                
                // 处理移动
                if (this.keys.left || this.touchControls.left) {
                    player.velocityX = -player.speed;
                } else if (this.keys.right || this.touchControls.right) {
                    player.velocityX = player.speed;
                } else {
                    player.velocityX = 0;
                }
                
                // 处理跳跃
                if ((this.keys.jump || this.touchControls.jump) && player.onGround) {
                    player.velocityY = player.jumpForce;
                    player.onGround = false;
                    // 重置跳跃按键状态，防止持续跳跃
                    this.keys.jump = false;
                    this.touchControls.jump = false;
                }
                
                // 更新位置
                player.x += player.velocityX;
                player.y += player.velocityY;
                
                // 边界检测
                if (player.x < 0) player.x = 0;
                if (player.x + player.width > this.canvas.width) player.x = this.canvas.width - player.width;
                
                // 平台碰撞检测
                player.onGround = false;
                for (const platform of this.platforms) {
                    if (this.checkCollision(player, platform)) {
                        // 从上方碰撞（站在平台上）
                        if (player.velocityY > 0 && 
                            player.y + player.height <= platform.y + 10 && 
                            player.y + player.height > platform.y) {
                            player.y = platform.y - player.height;
                            player.velocityY = 0;
                            player.onGround = true;
                        } 
                        // 从下方碰撞
                        else if (player.velocityY < 0 && 
                                 player.y >= platform.y + platform.height - 10 && 
                                 player.y < platform.y + platform.height) {
                            player.y = platform.y + platform.height;
                            player.velocityY = 0;
                        }
                        // 从左侧碰撞
                        else if (player.velocityX > 0 && 
                                 player.x + player.width <= platform.x + 10 && 
                                 player.x + player.width > platform.x) {
                            player.x = platform.x - player.width;
                        }
                        // 从右侧碰撞
                        else if (player.velocityX < 0 && 
                                 player.x >= platform.x + platform.width - 10 && 
                                 player.x < platform.x + platform.width) {
                            player.x = platform.x + platform.width;
                        }
                    }
                }
                
                // 金币收集检测
                for (const coin of this.coins) {
                    if (!coin.collected && this.checkCollision(player, coin)) {
                        coin.collected = true;
                        this.score += coin.value;
                        this.updateUI();
                    }
                }
                
                // 敌人碰撞检测
                for (const enemy of this.enemies) {
                    if (this.checkCollision(player, enemy)) {
                        this.gameOver = true;
                        this.gameRunning = false;
                        this.showGameOver();
                    }
                }
                
                // 掉落检测（游戏结束）
                if (player.y > this.canvas.height) {
                    this.gameOver = true;
                    this.gameRunning = false;
                    this.showGameOver();
                }
            }
            
            // 更新平台
            updatePlatforms() {
                // 移动平台（营造前进效果）
                for (const platform of this.platforms) {
                    platform.x -= this.speed;
                }
                
                // 移除超出屏幕的平台
                this.platforms = this.platforms.filter(platform => 
                    platform.x + platform.width > 0
                );
                
                // 生成新平台
                const currentTime = Date.now();
                if (currentTime - this.lastSpawnTime > this.spawnRate) {
                    const platformWidth = Math.random() * 100 + 80;
                    const platformX = this.canvas.width;
                    const platformY = Math.random() * (this.canvas.height - 150) + 50;
                    
                    this.createPlatform(platformX, platformY, platformWidth, 20);
                    
                    // 随机生成金币
                    if (Math.random() > 0.3) {
                        this.createCoin(
                            platformX + Math.random() * (platformWidth - 20),
                            platformY - 30
                        );
                    }
                    
                    // 随机生成敌人
                    if (Math.random() > 0.5 && this.level > 1) {
                        this.createEnemy(
                            platformX + Math.random() * (platformWidth - 30),
                            platformY - 30
                        );
                    }
                    
                    this.lastSpawnTime = currentTime;
                }
            }
            
            // 更新敌人
            updateEnemies() {
                // 移动敌人
                for (const enemy of this.enemies) {
                    enemy.x += enemy.speed * enemy.direction;
                    enemy.x -= this.speed; // 跟随平台移动
                    
                    // 敌人边界检测（在平台上移动）
                    for (const platform of this.platforms) {
                        if (this.checkCollision(enemy, platform)) {
                            // 改变方向
                            enemy.direction *= -1;
                        }
                    }
                }
                
                // 移除超出屏幕的敌人
                this.enemies = this.enemies.filter(enemy => 
                    enemy.x + enemy.width > 0
                );
            }
            
            // 更新金币
            updateCoins() {
                // 移动金币
                for (const coin of this.coins) {
                    coin.x -= this.speed;
                }
                
                // 移除超出屏幕或已收集的金币
                this.coins = this.coins.filter(coin => 
                    !coin.collected && coin.x + coin.size > 0
                );
            }
            
            // 更新游戏难度
            updateDifficulty() {
                // 每得100分升级
                const newLevel = Math.floor(this.score / 100) + 1;
                if (newLevel > this.level) {
                    this.level = newLevel;
                    this.speed += 0.5; // 增加速度
                    this.spawnRate = Math.max(800, this.spawnRate - 100); // 减少生成间隔
                    this.updateUI();
                }
            }
            
            // 更新UI
            updateUI() {
                document.getElementById('score').textContent = this.score;
                document.getElementById('level').textContent = this.level;
                document.getElementById('finalScore').textContent = this.score;
            }
            
            // 显示游戏结束界面
            showGameOver() {
                document.getElementById('gameOverScreen').classList.remove('hidden');
                document.getElementById('gameUI').classList.add('hidden');
                document.getElementById('touchControls').classList.add('hidden');
            }
            
            // 绘制背景
            drawBackground() {
                // 天空背景
                this.ctx.fillStyle = '#87CEEB';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // 地面
                this.ctx.fillStyle = '#9B7B6B';
                this.ctx.fillRect(0, this.canvas.height - 20, this.canvas.width, 20);
                
                // 云朵
                this.drawClouds();
            }
            
            // 绘制云朵
            drawClouds() {
                this.ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                
                // 移动的云朵
                const cloudCount = 3;
                for (let i = 0; i < cloudCount; i++) {
                    const x = (Date.now() * 0.0001 * (i + 1)) % this.canvas.width;
                    const y = 50 + i * 80;
                    
                    this.ctx.beginPath();
                    this.ctx.arc(x, y, 20, 0, Math.PI * 2);
                    this.ctx.arc(x + 25, y - 10, 15, 0, Math.PI * 2);
                    this.ctx.arc(x + 40, y, 20, 0, Math.PI * 2);
                    this.ctx.arc(x + 25, y + 10, 15, 0, Math.PI * 2);
                    this.ctx.fill();
                }
            }
            
            // 绘制玩家
            drawPlayer() {
                const player = this.player;
                
                // 绘制玩家身体
                this.ctx.fillStyle = player.color;
                this.ctx.fillRect(player.x, player.y, player.width, player.height);
                
                // 绘制玩家头部
                this.ctx.fillStyle = '#FFD700'; // 肤色
                this.ctx.beginPath();
                this.ctx.arc(player.x + player.width / 2, player.y - 10, 15, 0, Math.PI * 2);
                this.ctx.fill();
                
                // 绘制眼睛
                this.ctx.fillStyle = '#000';
                this.ctx.beginPath();
                this.ctx.arc(player.x + player.width / 2 - 5, player.y - 12, 3, 0, Math.PI * 2);
                this.ctx.arc(player.x + player.width / 2 + 5, player.y - 12, 3, 0, Math.PI * 2);
                this.ctx.fill();
            }
            
            // 绘制平台
            drawPlatforms() {
                for (const platform of this.platforms) {
                    this.ctx.fillStyle = platform.color;
                    this.ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
                    
                    // 平台纹理
                    this.ctx.fillStyle = '#38A169';
                    for (let i = 0; i < platform.width; i += 10) {
                        this.ctx.fillRect(platform.x + i, platform.y, 5, 5);
                    }
                }
            }
            
            // 绘制金币
            drawCoins() {
                for (const coin of this.coins) {
                    if (!coin.collected) {
                        // 金币主体
                        this.ctx.fillStyle = coin.color;
                        this.ctx.beginPath();
                        this.ctx.arc(coin.x + coin.size / 2, coin.y + coin.size / 2, coin.size / 2, 0, Math.PI * 2);
                        this.ctx.fill();
                        
                        // 金币纹理
                        this.ctx.fillStyle = '#FCC367';
                        for (let i = 0; i < 6; i++) {
                            const angle = (i * Math.PI / 3);
                            const x = coin.x + coin.size / 2 + Math.cos(angle) * coin.size / 4;
                            const y = coin.y + coin.size / 2 + Math.sin(angle) * coin.size / 4;
                            
                            this.ctx.beginPath();
                            this.ctx.arc(x, y, coin.size / 8, 0, Math.PI * 2);
                            this.ctx.fill();
                        }
                    }
                }
            }
            
            // 绘制敌人
            drawEnemies() {
                for (const enemy of this.enemies) {
                    this.ctx.fillStyle = enemy.color;
                    this.ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);
                    
                    // 敌人眼睛
                    this.ctx.fillStyle = '#FFF';
                    this.ctx.fillRect(enemy.x + 5, enemy.y + 5, 8, 8);
                    this.ctx.fillRect(enemy.x + enemy.width - 13, enemy.y + 5, 8, 8);
                    
                    // 敌人瞳孔
                    this.ctx.fillStyle = '#F00';
                    this.ctx.fillRect(enemy.x + 7, enemy.y + 7, 4, 4);
                    this.ctx.fillRect(enemy.x + enemy.width - 11, enemy.y + 7, 4, 4);
                }
            }
            
            // 绘制UI
            drawUI() {
                // 游戏中UI已通过HTML元素实现，这里可以添加额外的Canvas绘制UI
            }
            
            // 游戏更新
            update() {
                if (!this.gameRunning) return;
                
                this.updatePlayer();
                this.updatePlatforms();
                this.updateCoins();
                this.updateEnemies();
                this.updateDifficulty();
            }
            
            // 游戏绘制
            draw() {
                // 清除画布
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                this.drawBackground();
                this.drawPlatforms();
                this.drawCoins();
                this.drawEnemies();
                this.drawPlayer();
                this.drawUI();
            }
            
            // 游戏循环
            gameLoop() {
                this.update();
                this.draw();
                requestAnimationFrame(this.gameLoop.bind(this));
            }
        }
        
        // 启动游戏
        window.addEventListener('load', () => {
            new MarioGame();
        });
    </script>
</body>
</html>
